<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rout Now | Logística Avanzada</title>

    <!-- Leaflet CSS, MarkerCluster y Tailwind CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" rel="stylesheet">

    <!-- Estilos personalizados para el diseño original -->
    <style>
        :root {
            --primary-purple: #8b5cf6;
            --primary-green: #10b981;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { border-right: 4px solid var(--primary-purple); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-purple); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .depot-icon { background-color: #f59e0b; color: white; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; border: 3px solid white; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .parada-icon { background-color: #3b82f6; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.4); }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-container { transition: transform 0.3s ease; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <div class="sidebar w-[380px] bg-gray-50 flex flex-col z-20 h-full p-4 space-y-4 overflow-y-auto">
        <header class="text-left">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center"><i class="fa-solid fa-route text-purple-500 mr-3"></i>Rout Now</h1>
            <p class="text-sm text-green-500 font-semibold ml-10">● Conectado</p>
        </header>

        <!-- Stats -->
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white rounded-2xl shadow-md p-4 text-center">
                <p class="text-sm text-gray-500">Paradas</p>
                <p id="paradas-count" class="text-3xl font-bold text-purple-600">0</p>
            </div>
            <div class="bg-white rounded-2xl shadow-md p-4 text-center">
                <p class="text-sm text-gray-500">Vehículos</p>
                <p id="vehiculos-count" class="text-3xl font-bold text-purple-600">0</p>
            </div>
        </div>

        <!-- Carga de Archivo -->
        <div class="bg-white rounded-2xl shadow-md p-4">
            <h3 class="font-semibold text-gray-700 mb-2 flex items-center"><i class="fa-solid fa-upload mr-2 text-gray-400"></i>Cargar Paradas</h3>
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center">
                <p class="text-sm text-gray-500">Arrastra tu archivo o haz clic</p>
                <input type="file" id="file-upload" class="hidden">
                <button id="upload-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out flex items-center justify-center bg-purple-600 hover:bg-purple-700 text-white mt-2 w-full">Cargar Archivo</button>
            </div>
        </div>

        <!-- Flota -->
        <div class="bg-white rounded-2xl shadow-md p-4">
            <h3 class="font-semibold text-gray-700 mb-2 flex items-center"><i class="fa-solid fa-truck mr-2 text-gray-400"></i>Flota de Vehículos</h3>
            <div id="vehicle-list" class="space-y-2 max-h-28 overflow-y-auto pr-2"></div>
            <div class="grid grid-cols-1 gap-2 mt-2">
                <button id="add-vehicle-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out flex items-center justify-center bg-green-500 hover:bg-green-600 text-white"><i class="fa-solid fa-plus mr-2"></i>Añadir</button>
            </div>
        </div>

        <!-- Optimización -->
        <div class="bg-white rounded-2xl shadow-md p-4">
            <h3 class="font-semibold text-gray-700 mb-2 flex items-center"><i class="fa-solid fa-gears mr-2 text-gray-400"></i>Optimización</h3>
            <button id="optimize-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out flex items-center justify-center bg-purple-600 hover:bg-purple-700 text-white w-full text-base">
                <span id="optimize-btn-text">Optimizar Rutas</span>
                <div id="optimize-loader" class="loader hidden"></div>
            </button>
            <div class="grid grid-cols-2 gap-2 mt-2">
                <button id="analyze-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out flex items-center justify-center bg-gray-300 hover:bg-gray-400 text-gray-800 cursor-not-allowed" disabled>Analizar IA</button>
                <button id="export-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out flex items-center justify-center bg-gray-300 hover:bg-gray-400 text-gray-800 cursor-not-allowed" disabled>Exportar</button>
            </div>
             <button id="clear-all-btn" class="font-bold py-2 px-4 rounded-lg shadow-md transition-all duration-300 ease-in-out flex items-center justify-center bg-red-600 hover:bg-red-700 text-white w-full mt-2"><i class="fa-solid fa-trash mr-2"></i>Limpiar Todo</button>
        </div>
        
        <!-- Lista de Paradas -->
        <div class="bg-white rounded-2xl shadow-md p-4 flex-grow flex flex-col">
            <h3 class="font-semibold text-gray-700 mb-2 flex items-center"><i class="fa-solid fa-list-ol mr-2 text-gray-400"></i>Lista de Paradas</h3>
            <div id="paradas-list" class="flex-grow overflow-y-auto pr-2 text-sm">
                 <p class="text-gray-400 text-center mt-4">Añade un depósito en el mapa para empezar.</p>
            </div>
        </div>
    </div>

    <!-- Mapa -->
    <div class="flex-1 relative">
        <div id="map" class="h-full w-full"></div>
    </div>

    <!-- Modal para Análisis de IA -->
    <div id="ai-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div id="ai-modal-overlay" class="absolute inset-0 bg-black opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-lg z-50 overflow-y-auto transform scale-95">
            <div class="p-5">
                <div class="flex justify-between items-start">
                    <h3 class="text-2xl font-bold text-gray-800 flex items-center"><i class="fa-solid fa-lightbulb text-yellow-400 mr-3"></i>Análisis de IA</h3>
                    <button id="ai-modal-close" class="text-2xl font-bold text-gray-500 hover:text-gray-800">&times;</button>
                </div>
                <div id="ai-modal-content" class="mt-4 text-gray-600 space-y-2">
                    <!-- El contenido del análisis se insertará aquí -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- ESTADO Y CONFIGURACIÓN ---
        const API_BASE_URL = 'http://127.0.0.1:5000/api';
        const AppState = {
            sessionId: null, paradas: [], vehiculos: [], map: null,
            paradaMarkers: L.markerClusterGroup(), depotMarker: null, routeLayers: L.layerGroup(),
            routeColors: ['#ff00ff', '#00ff00', '#00ffff', '#ff8c00', '#ff1493', '#adff2f', '#48d1cc', '#ff4500']
        };

        // --- REFERENCIAS AL DOM ---
        const elements = {
            uploadBtn: document.getElementById('upload-btn'), fileUpload: document.getElementById('file-upload'),
            vehicleList: document.getElementById('vehicle-list'), addVehicleBtn: document.getElementById('add-vehicle-btn'),
            paradasList: document.getElementById('paradas-list'), paradasCount: document.getElementById('paradas-count'),
            vehiculosCount: document.getElementById('vehiculos-count'), optimizeBtn: document.getElementById('optimize-btn'),
            optimizeBtnText: document.getElementById('optimize-btn-text'), optimizeLoader: document.getElementById('optimize-loader'),
            analyzeBtn: document.getElementById('analyze-btn'), exportBtn: document.getElementById('export-btn'),
            clearAllBtn: document.getElementById('clear-all-btn'), map: document.getElementById('map'),
            aiModal: document.getElementById('ai-modal'), aiModalOverlay: document.getElementById('ai-modal-overlay'),
            aiModalClose: document.getElementById('ai-modal-close'), aiModalContent: document.getElementById('ai-modal-content')
        };

        // --- MÓDULO DE NOTIFICACIONES ---
        const Notifications = {
            show(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `fixed top-5 left-1/2 -translate-x-1/2 p-4 rounded-md text-white shadow-lg z-[10000] transition-opacity duration-300`;
                toast.textContent = message;
                if (type === 'success') toast.classList.add('bg-green-500');
                else if (type === 'error') toast.classList.add('bg-red-500');
                else toast.classList.add('bg-purple-500');
                document.body.appendChild(toast);
                setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 3000); }, 3000);
            }
        };
        
        // --- MÓDULO DE API ---
        const API = {
            async getSession() {
                const response = await fetch(`${API_BASE_URL}/session`);
                if (!response.ok) throw new Error("No se pudo iniciar la sesión.");
                AppState.sessionId = (await response.json()).session_id;
            },
            async request(endpoint, options = {}) {
                if (!AppState.sessionId) await this.getSession();
                const defaultOptions = { headers: { 'X-Session-ID': AppState.sessionId, ...options.headers } };
                const response = await fetch(`${API_BASE_URL}${endpoint}`, { ...options, ...defaultOptions });

                if (!response.ok) {
                    let errorMsg = `Error ${response.status}: ${response.statusText}`;
                    try {
                        const errorResult = await response.json();
                        errorMsg = errorResult.error || errorMsg;
                    } catch (jsonError) {
                        // El cuerpo no era JSON o estaba vacío
                    }
                    throw new Error(errorMsg);
                }

                if (options.isBlob) {
                    return response.blob();
                }
                return response.json();
            }
        };

        // --- GESTIÓN DEL MAPA ---
        const MapManager = {
            init() {
                AppState.map = L.map(elements.map).setView([4.60971, -74.08175], 12); // Bogotá
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(AppState.map);
                AppState.map.addLayer(AppState.paradaMarkers);
                AppState.map.addLayer(AppState.routeLayers);
                AppState.map.on('click', this.onMapClick);
            },
            onMapClick(e) {
                const isDepotDefined = AppState.paradas.some(p => p.isDepot);
                if (!isDepotDefined) {
                    ParadasManager.add({ lat: e.latlng.lat, lon: e.latlng.lng, nombre: 'Depósito Central', pasajeros: 0, isDepot: true });
                } else {
                    const nombre = prompt("Nombre de la parada:", `Parada ${AppState.paradas.length}`);
                    if (!nombre) return;
                    const pasajeros = parseInt(prompt("Número de pasajeros:", "1"));
                    if (isNaN(pasajeros) || pasajeros < 0) return;
                    ParadasManager.add({ lat: e.latlng.lat, lon: e.latlng.lng, nombre, pasajeros });
                }
            },
            redrawAllMarkers() {
                AppState.paradaMarkers.clearLayers();
                AppState.paradas.forEach(p => {
                    const iconHtml = p.isDepot ? `<i class="fa-solid fa-warehouse"></i>` : `<b>${p.pasajeros}</b>`;
                    const iconClass = p.isDepot ? 'depot-icon' : 'parada-icon';
                    const marker = L.marker([p.lat, p.lon], { icon: L.divIcon({ html: iconHtml, className: iconClass }) })
                        .bindPopup(`<b>${p.nombre}</b><br>Pasajeros: ${p.pasajeros}`);
                    AppState.paradaMarkers.addLayer(marker);
                });
            },
            drawRoutes(rutas) {
                this.clearRoutes();
                const depot = AppState.paradas.find(p => p.isDepot);
                if (!depot || !rutas) return;
                rutas.forEach((ruta, index) => {
                    const color = AppState.routeColors[index % AppState.routeColors.length];
                    const points = [ [depot.lat, depot.lon] ];
                    const paradasEnRuta = ruta.secuencia_paradas_ids.map(id => AppState.paradas.find(p => p.id === id));
                    paradasEnRuta.forEach(p => { if(p) points.push([p.lat, p.lon]) });
                    points.push([depot.lat, depot.lon]);
                    const polyline = L.polyline(points, { color, weight: 5, opacity: 0.9 });
                    polyline.bindTooltip(`Vehículo ${index + 1}`, { permanent: false });
                    AppState.routeLayers.addLayer(polyline);
                });
            },
            clearRoutes() { AppState.routeLayers.clearLayers(); }
        };

        // --- GESTIÓN DE PARADAS Y VEHÍCULOS ---
        const ParadasManager = {
            add(paradaData) {
                AppState.paradas.push({ id: `p_${Date.now()}`, ...paradaData });
                this.render();
                MapManager.redrawAllMarkers();
            },
            remove(paradaId) {
                AppState.paradas = AppState.paradas.filter(p => p.id !== paradaId);
                this.render();
                MapManager.redrawAllMarkers();
                MapManager.clearRoutes();
                UI.setPostOptimizeButtons(false);
            },
            render() {
                elements.paradasList.innerHTML = '';
                if(AppState.paradas.length === 0) {
                    elements.paradasList.innerHTML = '<p class="text-gray-400 text-center mt-4">Añade un depósito en el mapa para empezar.</p>';
                } else {
                    AppState.paradas.forEach(p => {
                        const el = document.createElement('div');
                        el.className = 'flex justify-between items-center p-2 bg-gray-100 rounded-md hover:bg-gray-200';
                        el.innerHTML = `
                            <span class="truncate">${p.isDepot ? '<i class="fa-solid fa-warehouse text-yellow-500"></i>' : '<i class="fa-solid fa-location-dot text-blue-500"></i>'} ${p.nombre} (${p.pasajeros})</span>
                            <button data-id="${p.id}" class="remove-parada-btn text-red-400 hover:text-red-600 ml-2"><i class="fa-solid fa-trash-can"></i></button>`;
                        elements.paradasList.appendChild(el);
                    });
                }
                UI.updateStats();
            }
        };

        const VehicleManager = {
            add(capacidad = 20) {
                AppState.vehiculos.push({ id: `v_${Date.now()}`, capacidad });
                this.render();
            },
            remove(vehiculoId) {
                AppState.vehiculos = AppState.vehiculos.filter(v => v.id !== vehiculoId);
                this.render();
            },
            update(vehiculoId, nuevaCapacidad) {
                const vehiculo = AppState.vehiculos.find(v => v.id === vehiculoId);
                if (vehiculo) vehiculo.capacidad = nuevaCapacidad;
            },
            render() {
                elements.vehicleList.innerHTML = '';
                AppState.vehiculos.forEach((v, index) => {
                    const el = document.createElement('div');
                    el.className = 'flex items-center space-x-2 p-1 bg-gray-100 rounded-md';
                    el.innerHTML = `
                        <label class="text-sm font-semibold text-gray-600">Vehículo ${index + 1}:</label>
                        <input type="number" value="${v.capacidad}" data-id="${v.id}" class="update-cap-input w-full p-1 border rounded-md text-center">
                        <button data-id="${v.id}" class="remove-vehicle-btn text-red-400 hover:text-red-600"><i class="fa-solid fa-trash-can"></i></button>`;
                    elements.vehicleList.appendChild(el);
                });
                UI.updateStats();
            }
        };

        // --- GESTIÓN DE UI ---
        const UI = {
            setLoading(isLoading) {
                elements.optimizeBtn.disabled = isLoading;
                elements.optimizeBtnText.classList.toggle('hidden', isLoading);
                elements.optimizeLoader.classList.toggle('hidden', !isLoading);
            },
            setPostOptimizeButtons(enabled) {
                elements.analyzeBtn.disabled = !enabled;
                elements.exportBtn.disabled = !enabled;
                elements.analyzeBtn.classList.toggle('bg-gray-300', !enabled);
                elements.analyzeBtn.classList.toggle('text-gray-800', !enabled);
                elements.analyzeBtn.classList.toggle('cursor-not-allowed', !enabled);
                elements.analyzeBtn.classList.toggle('bg-purple-600', enabled);
                elements.analyzeBtn.classList.toggle('hover:bg-purple-700', enabled);
                elements.analyzeBtn.classList.toggle('text-white', enabled);
                
                elements.exportBtn.classList.toggle('bg-gray-300', !enabled);
                elements.exportBtn.classList.toggle('text-gray-800', !enabled);
                elements.exportBtn.classList.toggle('cursor-not-allowed', !enabled);
                elements.exportBtn.classList.toggle('bg-green-600', enabled);
                elements.exportBtn.classList.toggle('hover:bg-green-700', enabled);
                elements.exportBtn.classList.toggle('text-white', enabled);
            },
            updateStats() {
                elements.paradasCount.textContent = AppState.paradas.filter(p => !p.isDepot).length;
                elements.vehiculosCount.textContent = AppState.vehiculos.length;
            },
            showAIModal(analysis) {
                elements.aiModalContent.innerHTML = analysis.insights.map(insight => 
                    `<p class="border-l-4 border-purple-300 pl-3">${insight.replace(/\*\*(.*?)\*\*/g, '<strong class="text-purple-600">$1</strong>')}</p>`
                ).join('');
                elements.aiModal.classList.remove('hidden');
                setTimeout(() => {
                    elements.aiModalOverlay.classList.remove('opacity-0');
                    elements.aiModal.querySelector('.modal-container').classList.remove('scale-95');
                }, 10);
            },
            hideAIModal() {
                elements.aiModalOverlay.classList.add('opacity-0');
                elements.aiModal.querySelector('.modal-container').classList.add('scale-95');
                setTimeout(() => elements.aiModal.classList.add('hidden'), 300);
            }
        };

        // --- INICIALIZACIÓN Y EVENTOS ---
        async function init() {
            try {
                await API.getSession();
                Notifications.show(`Sesión iniciada`, 'info');
            } catch(e) {
                Notifications.show(e.message, 'error'); return;
            }

            MapManager.init();
            VehicleManager.add(35);

            elements.uploadBtn.addEventListener('click', () => elements.fileUpload.click());
            elements.fileUpload.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('file', file);
                try {
                    const paradas = await API.request('/upload_paradas', { method: 'POST', body: formData, headers: {} });
                    paradas.forEach(p => ParadasManager.add(p));
                    Notifications.show(`${paradas.length} paradas cargadas.`, "success");
                } catch (err) {
                    Notifications.show(`Error al cargar: ${err.message}`, "error");
                }
                e.target.value = null;
            });

            elements.addVehicleBtn.addEventListener('click', () => VehicleManager.add());
            elements.vehicleList.addEventListener('change', e => {
                if (e.target.classList.contains('update-cap-input')) VehicleManager.update(e.target.dataset.id, parseInt(e.target.value) || 0);
            });
            elements.vehicleList.addEventListener('click', e => {
                const btn = e.target.closest('.remove-vehicle-btn');
                if (btn) VehicleManager.remove(btn.dataset.id);
            });
            elements.paradasList.addEventListener('click', e => {
                const btn = e.target.closest('.remove-parada-btn');
                if (btn) ParadasManager.remove(btn.dataset.id);
            });

            elements.optimizeBtn.addEventListener('click', async () => {
                if (AppState.paradas.length < 2 || !AppState.paradas.some(p => p.isDepot)) return Notifications.show("Añade un depósito y al menos una parada.", "error");
                UI.setLoading(true);
                UI.setPostOptimizeButtons(false);
                try {
                    const payload = { paradas: AppState.paradas, vehiculos: AppState.vehiculos };
                    const results = await API.request('/optimize', { method: 'POST', body: JSON.stringify(payload), headers: {'Content-Type': 'application/json'} });
                    MapManager.drawRoutes(results.rutas);
                    Notifications.show("Optimización completada.", "success");
                    UI.setPostOptimizeButtons(true);
                } catch (err) {
                    Notifications.show(`Error: ${err.message}`, "error");
                } finally {
                    UI.setLoading(false);
                }
            });

            elements.analyzeBtn.addEventListener('click', async () => {
                try {
                    const analysis = await API.request('/analyze', { method: 'POST' });
                    UI.showAIModal(analysis);
                } catch (e) {
                    Notifications.show(`Error en análisis: ${e.message}`, "error");
                }
            });
            
            elements.exportBtn.addEventListener('click', async () => {
                try {
                    const blob = await API.request('/export', { isBlob: true });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `RoutNow_Resultados.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    window.URL.revokeObjectURL(url);
                } catch (e) {
                    Notifications.show(`Error de exportación: ${e.message}`, "error");
                }
            });

            elements.clearAllBtn.addEventListener('click', async () => {
                if (!confirm("¿Seguro que quieres limpiar toda la sesión?")) return;
                try {
                    await API.request('/clear', { method: 'POST' });
                    AppState.paradas = []; AppState.vehiculos = [];
                    ParadasManager.render(); VehicleManager.render();
                    MapManager.redrawAllMarkers(); MapManager.clearRoutes();
                    UI.setPostOptimizeButtons(false);
                    Notifications.show("Sesión limpiada.", "info");
                } catch (e) {
                     Notifications.show(`Error: ${e.message}`, "error");
                }
            });
            
            elements.aiModalClose.addEventListener('click', UI.hideAIModal);
            elements.aiModalOverlay.addEventListener('click', UI.hideAIModal);
        }

        init();
    });
    </script>
</body>
</html>
